<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheeky Radio - Internet Radio for Raspberry Pi</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cheeky-dark': '#f5f5f5',
                        'cheeky-charcoal': '#efefef',
                        'cheeky-cyan': '#ff8c00',
                        'cheeky-blue': '#e0e0e0',
                        'cheeky-text': '#222222',
                        'cheeky-text-muted': '#666666',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'Poppins', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        body {
            background-color: #f5f5f5;
            color: #222222;
        }

        .gradient-text {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6b00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 900;
        }

        .skeleton {
            animation: pulse 2s infinite;
            background-color: #efefef;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .station-card {
            transition: all 0.2s ease;
            border: 2px solid #ddd;
        }

        .station-card:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0px rgba(255, 140, 0, 0.3);
            border-color: #ff8c00;
        }

        input:focus, textarea:focus {
            outline: none;
            box-shadow: inset 0 0 0 2px #ff8c00;
            border-color: #ff8c00 !important;
        }

        .play-button {
            transition: all 0.2s ease;
        }

        .play-button:hover {
            transform: scale(1.05);
        }

        .favorite-button {
            transition: all 0.15s ease;
        }

        .favorite-button:hover {
            transform: scale(1.15);
        }

        .scroll-smooth {
            scroll-behavior: smooth;
        }

        @keyframes bounce {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-cheeky-dark text-cheeky-text flex flex-col h-screen overflow-hidden">
    <div x-data="radioApp()" x-init="init()" class="flex flex-col h-full">
        <!-- Header -->
        <header class="flex-shrink-0 border-b-2 border-cheeky-charcoal bg-cheeky-dark z-50">
            <div class="px-3 sm:px-4 py-2 sm:py-3 flex items-center justify-between">
                <div class="flex items-center gap-2 sm:gap-3">
                    <div class="text-2xl sm:text-3xl lg:text-4xl font-black gradient-text">
                        ‚ô™ CHEEKY
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <div class="text-xs sm:text-sm font-bold text-cheeky-text-muted">
                        <span x-show="isConnected" class="text-cheeky-cyan">‚óè ONLINE</span>
                        <span x-show="!isConnected" class="text-red-600">‚óè OFFLINE</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content (scrollable) -->
        <div class="flex-1 overflow-y-auto px-3 sm:px-4 py-4 sm:py-6">
            <!-- Main Layout: Left column (now playing + sidebar) and right column (stations) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Left Column: Now Playing + Sidebar -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Now Playing Card -->
                    <div>
                        <div class="bg-cheeky-charcoal p-4 sm:p-6 border-2 border-cheeky-blue">
                            <div class="flex gap-4 sm:gap-6 items-start">
                                <!-- Album Art -->
                                <div class="flex-shrink-0">
                                    <div class="relative w-20 h-20 sm:w-28 sm:h-28 overflow-hidden bg-cheeky-blue border-2 border-cheeky-text">
                                        <img
                                            :src="currentStation?.favicon || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23ff8c00%22 font-size=%2240%22%3E‚ô™%3C/text%3E%3C/svg%3E'"
                                            alt="Station Logo"
                                            class="w-full h-full object-cover"
                                            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23ff8c00%22 font-size=%2240%22%3E‚ô™%3C/text%3E%3C/svg%3E'"
                                        >
                                        <div x-show="isPlaying" class="absolute inset-0 flex items-center justify-center bg-black/30">
                                            <div class="flex gap-1">
                                                <div class="w-1 h-3 bg-cheeky-cyan" style="animation: bounce 1s infinite;"></div>
                                                <div class="w-1 h-3 bg-cheeky-cyan" style="animation: bounce 1s infinite; animation-delay: 0.2s;"></div>
                                                <div class="w-1 h-3 bg-cheeky-cyan" style="animation: bounce 1s infinite; animation-delay: 0.4s;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Station Info & Controls -->
                                <div class="flex-1 min-w-0">
                                    <!-- Station Name -->
                                    <h2 class="text-lg sm:text-xl font-black mb-1 truncate" x-text="currentStation?.name || 'No Station'"></h2>

                                    <!-- Metadata -->
                                    <p class="text-xs sm:text-sm text-cheeky-text-muted mb-3 truncate" x-text="currentMetadata?.title || 'Waiting...'"></p>

                                    <!-- Volume Control -->
                                    <div class="mb-3 hidden sm:block">
                                        <label class="text-xs font-bold text-cheeky-text-muted block mb-1 uppercase">Vol</label>
                                        <div class="flex items-center gap-2">
                                            <input
                                                type="range"
                                                min="0"
                                                max="100"
                                                x-model="volume"
                                                @change="setVolume()"
                                                class="flex-1 h-1 bg-cheeky-blue appearance-none cursor-pointer accent-cheeky-cyan"
                                            >
                                            <span class="text-cheeky-cyan font-black w-6 text-right text-xs" x-text="volume + '%'"></span>
                                        </div>
                                    </div>

                                    <!-- Playback Controls -->
                                    <div class="flex gap-1 sm:gap-2">
                                        <button
                                            @click="previousStation()"
                                            class="play-button p-1 sm:p-2 bg-cheeky-blue text-cheeky-text border-2 border-cheeky-text transition-all hover:bg-cheeky-cyan hover:text-cheeky-dark"
                                            title="Previous Station"
                                        >
                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
                                        </button>

                                        <button
                                            @click="togglePlayPause()"
                                            class="play-button flex-1 p-1 sm:p-2 bg-cheeky-cyan text-cheeky-dark font-black text-xs transition-all hover:bg-orange-700 hover:text-white border-2 border-cheeky-text"
                                        >
                                            <span x-show="!isPlaying" class="hidden sm:inline">‚ñ∂ PLAY</span>
                                            <span x-show="!isPlaying" class="sm:hidden">‚ñ∂</span>
                                            <span x-show="isPlaying" class="hidden sm:inline">‚ùö‚ùö PAUSE</span>
                                            <span x-show="isPlaying" class="sm:hidden">‚ùö‚ùö</span>
                                        </button>

                                        <button
                                            @click="stop()"
                                            class="play-button p-1 sm:p-2 bg-cheeky-blue text-cheeky-text border-2 border-cheeky-text transition-all hover:bg-red-600 hover:text-white"
                                            title="Stop"
                                        >
                                            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 4h12v12H6V4z"/></svg>
                                        </button>

                                        <button
                                            @click="toggleFavorite()"
                                            class="favorite-button p-1 sm:p-2 border-2 transition-all text-lg sm:text-base"
                                            :class="isFavorite ? 'border-cheeky-cyan bg-cheeky-cyan text-cheeky-dark' : 'border-cheeky-text bg-cheeky-charcoal text-cheeky-text'"
                                            title="Toggle Favorite"
                                        >
                                            <span x-show="isFavorite">‚ô•</span>
                                            <span x-show="!isFavorite">‚ô°</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <aside>
                    <!-- Search -->
                    <div class="mb-8">
                        <input
                            type="text"
                            x-model="searchQuery"
                            @keyup.debounce="search()"
                            placeholder="Search stations..."
                            class="w-full px-4 py-3 bg-cheeky-charcoal border-2 border-cheeky-text text-cheeky-text placeholder-cheeky-text-muted focus:border-cheeky-cyan focus:bg-white transition-all font-semibold"
                        >
                    </div>

                    <!-- Favorites Section -->
                    <div class="mb-8">
                        <h3 class="text-sm font-black mb-4 flex items-center gap-2 uppercase">
                            <span>‚òÖ</span> Favorites
                        </h3>
                        <div class="space-y-2">
                            <template x-for="fav in favorites" :key="fav.uuid">
                                <button
                                    @click="playStation(fav)"
                                    class="w-full text-left px-3 py-2 bg-cheeky-charcoal border-2 border-cheeky-blue text-cheeky-text hover:border-cheeky-cyan hover:bg-white transition-all truncate font-semibold text-sm"
                                    :class="currentStation?.uuid === fav.uuid ? 'border-cheeky-cyan bg-cheeky-cyan text-cheeky-dark' : ''"
                                    :title="fav.name"
                                    x-text="fav.name"
                                ></button>
                            </template>
                            <p x-show="favorites.length === 0" class="text-cheeky-text-muted text-sm italic">No favorites yet</p>
                        </div>
                    </div>

                    <!-- Recent Section -->
                    <div class="mb-8">
                        <h3 class="text-sm font-black mb-4 flex items-center gap-2 uppercase">
                            <span>üïê</span> Recent
                        </h3>
                        <div class="space-y-2">
                            <template x-for="rec in recent" :key="rec.uuid">
                                <button
                                    @click="playStationByUuid(rec.uuid, rec.name)"
                                    class="w-full text-left px-3 py-2 bg-cheeky-charcoal border-2 border-cheeky-blue text-cheeky-text hover:border-cheeky-cyan hover:bg-white transition-all truncate font-semibold text-sm"
                                    :title="rec.name"
                                    x-text="rec.name"
                                ></button>
                            </template>
                            <p x-show="recent.length === 0" class="text-cheeky-text-muted text-sm italic">No recent history</p>
                        </div>
                    </div>

                    <!-- Browse Section -->
                    <div class="mb-8">
                        <h3 class="text-sm font-black mb-4 flex items-center gap-2 uppercase">
                            <span>üìÇ</span> Browse
                        </h3>
                        <div class="space-y-2">
                            <button
                                @click="showBrowseGenre = !showBrowseGenre"
                                class="w-full text-left px-3 py-2 bg-cheeky-charcoal border-2 border-cheeky-blue text-cheeky-text hover:border-cheeky-cyan hover:bg-white transition-all font-semibold text-sm"
                            >
                                By Genre ‚Üí
                            </button>
                            <button
                                @click="loadPopular()"
                                class="w-full text-left px-3 py-2 bg-cheeky-charcoal border-2 border-cheeky-blue text-cheeky-text hover:border-cheeky-cyan hover:bg-white transition-all font-semibold text-sm"
                            >
                                Popular
                            </button>
                        </div>
                    </div>

                    <!-- Bluetooth Manager Section -->
                    <div>
                        <h3 class="text-sm font-black mb-4 flex items-center gap-2 uppercase">
                            <span>üîµ</span> Speakers
                        </h3>

                        <!-- Scan Button -->
                        <button
                            @click="scanBluetoothDevices()"
                            class="w-full px-3 py-2 bg-cheeky-cyan text-cheeky-dark font-black border-2 border-cheeky-text hover:bg-orange-700 hover:text-white transition-all mb-4 text-sm uppercase"
                        >
                            üîç Scan
                        </button>

                        <!-- Devices List -->
                        <div class="space-y-2">
                            <template x-for="device in bluetoothDevices" :key="device.mac">
                                <div class="bg-cheeky-charcoal p-3 border-2 border-cheeky-blue">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex-1 min-w-0">
                                            <p class="font-semibold truncate text-sm" :title="device.name" x-text="device.name"></p>
                                            <p class="text-xs text-cheeky-text-muted" x-text="device.mac"></p>
                                        </div>
                                        <div class="flex gap-1 ml-2">
                                            <span x-show="device.connected" class="text-xs px-2 py-1 border border-cheeky-cyan bg-cheeky-cyan text-cheeky-dark font-bold">CONNECTED</span>
                                            <span x-show="!device.connected && device.paired" class="text-xs px-2 py-1 border border-cheeky-blue bg-cheeky-blue text-cheeky-text font-bold">PAIRED</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button
                                            x-show="!device.connected"
                                            @click="connectBluetoothDevice(device.mac)"
                                            class="flex-1 px-2 py-1 text-xs bg-cheeky-blue hover:bg-cheeky-cyan text-cheeky-text hover:text-cheeky-dark transition-all border border-cheeky-text font-semibold"
                                        >
                                            Connect
                                        </button>
                                        <button
                                            x-show="device.connected"
                                            @click="disconnectBluetoothDevice(device.mac)"
                                            class="flex-1 px-2 py-1 text-xs bg-red-600 hover:bg-red-700 text-white transition-all border border-red-900 font-semibold"
                                        >
                                            Disconnect
                                        </button>
                                        <button
                                            @click="removeBluetoothDevice(device.mac)"
                                            class="px-2 py-1 text-xs bg-gray-400 hover:bg-red-600 text-cheeky-dark hover:text-white transition-all border border-cheeky-text font-semibold"
                                            title="Remove Device"
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                            </template>
                            <p x-show="bluetoothDevices.length === 0" class="text-cheeky-text-muted text-sm italic">No Bluetooth devices</p>
                        </div>
                    </div>
                    </aside>
                </div>

                <!-- Right Column: Stations Grid -->
                <main class="lg:col-span-2">
                    <!-- Search Results / Stations Grid -->
                    <div>
                        <h2 class="text-lg sm:text-2xl font-black mb-4 sm:mb-6 uppercase" x-text="searchQuery ? `Search Results for "${searchQuery}"` : 'Popular Stations'"></h2>

                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6">
                            <template x-for="station in stations" :key="station.uuid">
                                <div class="station-card bg-cheeky-charcoal p-3 sm:p-5 border-2 border-cheeky-text hover:border-cheeky-cyan transition-all">
                                    <!-- Station Logo -->
                                    <div class="mb-3 sm:mb-4 h-16 sm:h-20 overflow-hidden bg-cheeky-blue flex items-center justify-center border border-cheeky-text">
                                        <img
                                            :src="station.favicon || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23ff8c00%22 font-size=%2240%22%3E‚ô™%3C/text%3E%3C/svg%3E'"
                                            :alt="station.name"
                                            class="w-full h-full object-cover"
                                            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23ff8c00%22 font-size=%2240%22%3E‚ô™%3C/text%3E%3C/svg%3E'"
                                        >
                                    </div>

                                    <!-- Station Info -->
                                    <h3 class="font-bold text-xs sm:text-sm mb-1 truncate" :title="station.name" x-text="station.name"></h3>
                                    <p class="text-xs text-cheeky-text-muted mb-2 hidden sm:block">
                                        <span x-text="station.country || 'Unknown'"></span>
                                        <span x-show="station.bitrate"> ‚Ä¢ <span x-text="station.bitrate + 'kbps'"></span></span>
                                    </p>

                                    <!-- Controls -->
                                    <div class="flex gap-1 sm:gap-2">
                                        <button
                                            @click="playStation(station)"
                                            class="flex-1 px-2 sm:px-3 py-1 sm:py-2 bg-cheeky-cyan text-cheeky-dark font-black hover:bg-orange-700 hover:text-white transition-all text-xs sm:text-sm border-2 border-cheeky-text uppercase"
                                        >
                                            <span class="hidden sm:inline">‚ñ∂ Play</span>
                                            <span class="sm:hidden">‚ñ∂</span>
                                        </button>
                                        <button
                                            @click="toggleStationFavorite(station)"
                                            class="px-2 sm:px-3 py-1 sm:py-2 border-2 transition-all font-bold text-lg sm:text-base"
                                            :class="isStationFavorite(station.uuid) ? 'border-cheeky-cyan bg-cheeky-cyan text-cheeky-dark' : 'border-cheeky-text bg-cheeky-charcoal text-cheeky-text hover:border-cheeky-cyan'"
                                        >
                                            <span x-show="isStationFavorite(station.uuid)">‚ô•</span>
                                            <span x-show="!isStationFavorite(station.uuid)">‚ô°</span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Loading State with Spinner -->
                        <div x-show="loading" class="flex flex-col items-center justify-center py-16 sm:py-20">
                            <div class="mb-6">
                                <div class="spinner text-cheeky-cyan text-6xl">
                                    ‚ô™
                                </div>
                            </div>
                            <p class="text-cheeky-text font-bold text-lg sm:text-xl mb-2">Updating Stations</p>
                            <p class="text-cheeky-text-muted text-sm sm:text-base">Loading your favorite stations...</p>
                        </div>

                        <!-- Initial State (First Load) -->
                        <div x-show="stations.length === 0 && !loading && isInitializing" class="flex flex-col items-center justify-center py-16 sm:py-20">
                            <div class="mb-6">
                                <div class="text-6xl animate-pulse">
                                    ‚ô™
                                </div>
                            </div>
                            <p class="text-cheeky-text font-bold text-lg sm:text-xl mb-2">Ready to Discover!</p>
                            <p class="text-cheeky-text-muted text-sm sm:text-base max-w-sm text-center">Stations will appear here once we've loaded them from our database. You can also search or browse categories on the left.</p>
                        </div>

                        <!-- Empty State -->
                        <div x-show="stations.length === 0 && !loading && !isInitializing" class="flex flex-col items-center justify-center py-16 sm:py-20">
                            <div class="mb-6 text-5xl">üìª</div>
                            <p class="text-cheeky-text font-bold text-lg sm:text-xl mb-2">No Stations Found</p>
                            <p class="text-cheeky-text-muted text-sm sm:text-base max-w-xs text-center">Try a different search or browse by category</p>
                        </div>

                        <!-- Pagination -->
                        <div x-show="totalStations > 0" class="mt-6 sm:mt-8 flex justify-center gap-2 sm:gap-4">
                            <button
                                @click="previousPage()"
                                :disabled="currentPage === 0"
                                class="px-3 sm:px-6 py-1 sm:py-2 border-2 border-cheeky-text bg-cheeky-charcoal text-cheeky-text hover:border-cheeky-cyan hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed transition-all font-bold text-xs sm:text-base"
                            >
                                <span class="hidden sm:inline">‚Üê Previous</span>
                                <span class="sm:hidden">‚Üê</span>
                            </button>
                            <span class="px-2 sm:px-4 py-1 sm:py-2 text-cheeky-text font-bold text-xs sm:text-base">
                                <span class="hidden sm:inline">Page </span><span x-text="currentPage + 1"></span>
                            </span>
                            <button
                                @click="nextPage()"
                                :disabled="(currentPage + 1) * 20 >= totalStations"
                                class="px-3 sm:px-6 py-1 sm:py-2 border-2 border-cheeky-text bg-cheeky-charcoal text-cheeky-text hover:border-cheeky-cyan hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed transition-all font-bold text-xs sm:text-base"
                            >
                                <span class="hidden sm:inline">Next ‚Üí</span>
                                <span class="sm:hidden">‚Üí</span>
                            </button>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Footer with Progress Bar -->
        <footer class="flex-shrink-0 border-t-2 border-cheeky-charcoal bg-cheeky-dark">
            <!-- Progress Bar -->
            <div class="w-full bg-cheeky-blue h-2 sm:h-3 relative overflow-hidden">
                <div
                    class="bg-cheeky-cyan h-full transition-all duration-300 ease-out"
                    :style="{ width: playProgress + '%' }"
                    x-ref="progressBar"
                ></div>
            </div>

            <!-- Time Display and Volume -->
            <div class="px-3 sm:px-4 py-2 sm:py-3 flex items-center justify-between text-xs sm:text-sm">
                <div class="flex items-center gap-2 sm:gap-3 flex-1">
                    <span class="text-cheeky-text-muted font-semibold" x-text="formatTime(playbackTime) + ' / ' + formatTime(playbackDuration)"></span>
                </div>
                <div class="hidden sm:flex items-center gap-2">
                    <span class="text-cheeky-text-muted font-semibold">VOL:</span>
                    <input
                        type="range"
                        min="0"
                        max="100"
                        x-model="volume"
                        @change="setVolume()"
                        class="w-20 h-1 bg-cheeky-blue appearance-none cursor-pointer accent-cheeky-cyan"
                    >
                    <span class="text-cheeky-cyan font-black w-6 text-right" x-text="volume + '%'"></span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Alpine.js App Logic -->
    <script>
        function radioApp() {
            return {
                // State
                isConnected: false,
                isPlaying: false,
                isFavorite: false,
                volume: 75,
                loading: false,
                isInitializing: true,
                searchQuery: '',
                currentPage: 0,
                stations: [],
                totalStations: 0,
                favorites: [],
                recent: [],
                currentStation: null,
                currentMetadata: {},
                showBrowseGenre: false,
                bluetoothDevices: [],
                ws: null,
                playProgress: 0,
                playbackTime: 0,
                playbackDuration: 0,

                // Initialize
                async init() {
                    await this.loadFavorites();
                    await this.loadRecent();
                    await this.loadBluetoothDevices();
                    await this.loadPopular();
                    await this.loadStatus();
                    this.connectWebSocket();
                },

                // WebSocket
                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

                    this.ws.onopen = () => {
                        this.isConnected = true;
                        console.log('[Cheeky] WebSocket connected');
                    };

                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };

                    this.ws.onclose = () => {
                        this.isConnected = false;
                        console.log('[Cheeky] WebSocket disconnected');
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                },

                handleWebSocketMessage(data) {
                    if (data.type === 'playback_status') {
                        this.isPlaying = data.status === 'playing';
                        if (data.station) {
                            this.currentStation = data.station;
                        }
                    } else if (data.type === 'metadata_update') {
                        this.currentMetadata = data;
                    } else if (data.type === 'volume_change') {
                        this.volume = data.volume;
                    } else if (data.type === 'favorites_updated') {
                        this.loadFavorites();
                    }
                },

                // API Calls
                async apiCall(method, endpoint, body = null) {
                    try {
                        const options = {
                            method,
                            headers: { 'Content-Type': 'application/json' }
                        };
                        if (body) options.body = JSON.stringify(body);

                        console.log(`[Cheeky] API ${method} /api${endpoint}`);
                        const response = await fetch(`/api${endpoint}`, options);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const result = await response.json();
                        console.log(`[Cheeky] API response:`, result);
                        return result;
                    } catch (error) {
                        console.error(`[Cheeky] API Error on ${endpoint}: ${error.message}`);
                        return null;
                    }
                },

                // Station Management
                async playStation(station) {
                    this.loading = true;
                    const result = await this.apiCall('POST', '/player/play', {
                        station_uuid: station.uuid,
                        stream_url: station.url,
                        station_name: station.name,
                        station_favicon: station.favicon
                    });

                    if (result) {
                        this.currentStation = station;
                        this.isPlaying = true;
                        this.isFavorite = await this.isStationFavorite(station.uuid);
                    }
                    this.loading = false;
                },

                async playStationByUuid(uuid, name) {
                    // Fetch station details first
                    const station = await this.apiCall('GET', `/stations/${uuid}`);
                    if (station) {
                        await this.playStation(station);
                    }
                },

                async togglePlayPause() {
                    if (this.isPlaying) {
                        await this.apiCall('POST', '/player/pause');
                        this.isPlaying = false;
                    } else if (this.currentStation) {
                        await this.apiCall('POST', '/player/play', {
                            station_uuid: this.currentStation.uuid,
                            stream_url: this.currentStation.url,
                            station_name: this.currentStation.name,
                            station_favicon: this.currentStation.favicon
                        });
                        this.isPlaying = true;
                    }
                },

                async stop() {
                    await this.apiCall('POST', '/player/stop');
                    this.isPlaying = false;
                },

                async setVolume() {
                    await this.apiCall('POST', '/player/volume', { volume: parseInt(this.volume) });
                },

                // Search & Browse
                async search() {
                    if (!this.searchQuery.trim()) {
                        await this.loadPopular();
                        return;
                    }

                    this.loading = true;
                    this.currentPage = 0;
                    const result = await this.apiCall('GET', `/stations/search?q=${encodeURIComponent(this.searchQuery)}&limit=20&offset=0`);

                    if (result) {
                        this.stations = result.stations;
                        this.totalStations = result.total;
                    }
                    this.loading = false;
                    this.isInitializing = false;
                },

                async loadPopular() {
                    this.loading = true;
                    this.searchQuery = '';
                    this.currentPage = 0;
                    const result = await this.apiCall('GET', '/stations/popular?limit=20&offset=0');

                    if (result) {
                        this.stations = result.stations;
                        this.totalStations = result.total;
                    }
                    this.loading = false;
                    this.isInitializing = false;
                },

                // Pagination
                async nextPage() {
                    this.currentPage++;
                    const offset = this.currentPage * 20;

                    let endpoint = `/stations/popular?limit=20&offset=${offset}`;
                    if (this.searchQuery) {
                        endpoint = `/stations/search?q=${encodeURIComponent(this.searchQuery)}&limit=20&offset=${offset}`;
                    }

                    this.loading = true;
                    const result = await this.apiCall('GET', endpoint);
                    if (result) {
                        this.stations = result.stations;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                    this.loading = false;
                },

                async previousPage() {
                    if (this.currentPage > 0) {
                        this.currentPage--;
                        const offset = this.currentPage * 20;

                        let endpoint = `/stations/popular?limit=20&offset=${offset}`;
                        if (this.searchQuery) {
                            endpoint = `/stations/search?q=${encodeURIComponent(this.searchQuery)}&limit=20&offset=${offset}`;
                        }

                        this.loading = true;
                        const result = await this.apiCall('GET', endpoint);
                        if (result) {
                            this.stations = result.stations;
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                        this.loading = false;
                    }
                },

                // Favorites
                async loadFavorites() {
                    const result = await this.apiCall('GET', '/favorites');
                    if (result) {
                        this.favorites = result.favorites;
                    }
                },

                async isStationFavorite(uuid) {
                    return this.favorites.some(f => f.uuid === uuid);
                },

                async toggleFavorite() {
                    if (!this.currentStation) return;

                    if (await this.isStationFavorite(this.currentStation.uuid)) {
                        await this.apiCall('DELETE', `/favorites/${this.currentStation.uuid}`);
                    } else {
                        await this.apiCall('POST', '/favorites', this.currentStation);
                    }

                    await this.loadFavorites();
                    this.isFavorite = await this.isStationFavorite(this.currentStation.uuid);
                },

                async toggleStationFavorite(station) {
                    if (await this.isStationFavorite(station.uuid)) {
                        await this.apiCall('DELETE', `/favorites/${station.uuid}`);
                    } else {
                        await this.apiCall('POST', '/favorites', station);
                    }
                    await this.loadFavorites();
                },

                // Recent History
                async loadRecent() {
                    const result = await this.apiCall('GET', '/recent');
                    if (result) {
                        this.recent = result.recent;
                    }
                },

                // Status
                async loadStatus() {
                    const result = await this.apiCall('GET', '/player/status');
                    if (result) {
                        this.volume = result.volume;
                        this.isPlaying = result.status === 'playing';
                        if (result.station) {
                            this.currentStation = result.station;
                            this.isFavorite = await this.isStationFavorite(result.station.uuid);
                        }
                    }
                },

                // Bluetooth Management
                async loadBluetoothDevices() {
                    const result = await this.apiCall('GET', '/bluetooth/devices');
                    if (result) {
                        this.bluetoothDevices = result.devices || [];
                    }
                },

                async scanBluetoothDevices() {
                    const result = await this.apiCall('POST', '/bluetooth/scan');
                    if (result) {
                        console.log('[Cheeky] Scanning for Bluetooth devices...');
                        // Reload devices after scan
                        setTimeout(() => this.loadBluetoothDevices(), 2000);
                    }
                },

                async connectBluetoothDevice(mac) {
                    const result = await this.apiCall('POST', '/bluetooth/connect', { mac });
                    if (result) {
                        console.log(`[Cheeky] Connected to ${mac}`);
                        await this.loadBluetoothDevices();
                    }
                },

                async disconnectBluetoothDevice(mac) {
                    const result = await this.apiCall('POST', '/bluetooth/disconnect', { mac });
                    if (result) {
                        console.log(`[Cheeky] Disconnected from ${mac}`);
                        await this.loadBluetoothDevices();
                    }
                },

                async removeBluetoothDevice(mac) {
                    if (confirm(`Remove ${mac}?`)) {
                        const result = await this.apiCall('POST', '/bluetooth/remove', { mac });
                        if (result) {
                            console.log(`[Cheeky] Removed ${mac}`);
                            await this.loadBluetoothDevices();
                        }
                    }
                },

                previousStation() {
                    if (this.recent.length > 1) {
                        const prev = this.recent[1];
                        this.playStationByUuid(prev.uuid, prev.name);
                    }
                },

                // Helper Methods
                formatTime(seconds) {
                    if (!seconds || isNaN(seconds)) return '0:00';
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);

                    if (hours > 0) {
                        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    }
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                },

                updateProgress() {
                    if (this.playbackDuration > 0) {
                        this.playProgress = (this.playbackTime / this.playbackDuration) * 100;
                    }
                }
            }
        }
    </script>
</body>
</html>
